<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>叶子出品 DICOM Tag 查看器 (本地化版)</title>
    
    <script src="./pyodide.js"></script>
    
    <style>
        /* 全局样式 */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            padding: 20px;
            background-color: #f5f5f5;
            margin: 0;
            line-height: 1.5;
        }
        .container {
            max-width: 100vw;
            margin: 0;
            background-color: white;
            border-radius: 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px 0;
        }
        h1 {
            text-align: center;
            color: #333;
            margin-top: 0;
        }

        /* 上传区域 */
        #drop_zone {
            border: 2px dashed #ccc;
            border-radius: 4px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.3s, background-color 0.3s;
            margin: 0 20px 20px 20px;
        }
        #drop_zone.dragover {
            border-color: #007bff;
            background-color: #e9f5ff;
        }
        #file_input {
            display: none;
        }
        
        /* 文件列表 */
        #file-list-display {
            padding: 10px 20px;
            border-bottom: 1px solid #eee;
            margin-bottom: 15px;
            min-height: 50px;
        }
        .file-tag {
            display: inline-flex;
            align-items: center;
            background-color: #e9ecef;
            border-radius: 3px;
            padding: 3px 8px;
            margin: 5px 8px 5px 0;
            font-size: 0.9em;
        }
        .file-tag-delete {
            margin-left: 5px;
            cursor: pointer;
            color: #6c757d;
            font-weight: bold;
        }

        /* 状态信息 */
        #status-message {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background-color: #007bff;
            color: white;
            text-align: center;
            padding: 10px 0;
            font-weight: bold;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
            visibility: hidden;
        }
        #status-message.show {
            opacity: 1;
            visibility: visible;
        }
        #status-message.error {
            background-color: #dc3545;
        }

        /* 控制按钮 */
        .controls {
            display: flex;
            justify-content: flex-start;
            gap: 10px;
            padding: 0 20px 15px;
        }
        .controls button {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.2s;
        }
        #hide-same-btn {
            background-color: #ffc107;
            color: #333;
        }
        #hide-same-btn:hover:not(:disabled) { background-color: #e0a800; }

        #show-all-btn {
            background-color: #17a2b8;
            color: white;
        }
        #show-all-btn:hover:not(:disabled) { background-color: #138496; }

        #clear-btn {
            background-color: #dc3545;
            color: white;
        }
        #clear-btn:hover:not(:disabled) { background-color: #c82333; }

        .controls button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
            color: #666;
        }

        /* 表格样式 */
        #table-container {
            margin: 0 20px;
            max-height: 70vh; /* 限制表格容器高度 */
            overflow: auto; /* 容器内部滚动 */
            border: 1px solid #ddd;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85em;
            background-color: white;
        }
        thead {
            position: sticky; /* 粘性表头 */
            top: 0;
            background-color: #f8f9fa;
            z-index: 10;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
            vertical-align: top;
            max-height: 100px;
            overflow-y: auto;
            white-space: pre-wrap; /* 允许换行 */
        }
        
        /* 差异高亮颜色 */
        .freq-low { background-color: #ffcccc; } /* 只有该文件是此值 (差异最大) */
        .freq-medium { background-color: #ffe5e5; } /* 少数文件是此值 (中等差异) */
        
        /* 特定列的宽度 */
        th:nth-child(1), td:nth-child(1) { /* Tag 列 */
            width: 90px;
        }
        th:nth-child(2), td:nth-child(2) { /* Tag Name 列 */
            width: 180px;
        }
        th:nth-child(3), td:nth-child(3) { /* VR 列 */
            width: 40px; 
            text-align: center;
        }
        th:nth-child(4), td:nth-child(4) { /* VM 列 */
            width: 40px; 
            text-align: center;
        }
        th:nth-child(n+5), td:nth-child(n+5) { /* 文件值列 */
            min-width: 150px;
            max-width: 250px;
        }
        
        td code {
            font-size: 0.9em;
            color: #007bff;
        }
        .file-name-row {
            font-weight: bold;
            background-color: #f1f1f1;
        }
        .tag-name-cell {
            font-weight: 500;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>DICOM Tag 查看与比较工具</h1>

        <div id="status-message">正在加载 Pyodide 环境...</div>
        
        <div id="drop_zone">
            将 DICOM 文件拖拽到此处，或点击选择文件
            <input type="file" id="file_input" multiple accept=".dcm, .dicom">
        </div>

        <div id="file-list-display"></div>

        <div class="controls">
            <button id="hide-same-btn" disabled>只显示差异 Tag</button>
            <button id="show-all-btn" disabled>显示全部 Tag</button>
            <button id="clear-btn" disabled>清空文件</button>
        </div>

        <div id="table-container">
            <p style="text-align: center; padding: 20px;">等待文件上传...</p>
        </div>
    </div>

<script>
    // 全局变量
    let pyodide = null;
    let currentParsedData = null;
    let loadedFiles = new Map(); // 使用 Map 存储文件名和 ArrayBuffer
    let hideSameTags = false;

    // DOM 元素
    const dropZone = document.getElementById('drop_zone');
    const fileInput = document.getElementById('file_input');
    const tableContainer = document.getElementById('table-container');
    const fileListDisplay = document.getElementById('file-list-display');
    const statusDiv = document.getElementById('status-message');
    const hideSameBtn = document.getElementById('hide-same-btn');
    const showAllBtn = document.getElementById('show-all-btn');
    const clearBtn = document.getElementById('clear-btn');

    // --- 状态显示函数 ---
    function showStatus(message, isError = false) {
        statusDiv.textContent = message;
        statusDiv.className = 'show' + (isError ? ' error' : '');
    }

    function hideStatus() {
        statusDiv.className = '';
        statusDiv.classList.remove('error');
    }

    // --- Pyodide 初始化和本地安装 pydicom ---
    async function main() {
        try {
            showStatus('正在加载 Pyodide v0.29.0 核心环境...');
            
            // 关键修改 1：使用 indexURL "./" 指向当前目录，加载核心文件
            // 确保文件 pyodide.asm.js, pyodide.asm.wasm 位于当前目录
            pyodide = await loadPyodide({
                 indexURL: "./" 
            });

            showStatus('正在加载 Python 包管理器 (micropip)...');
            await pyodide.loadPackage("micropip");
            const micropip = pyodide.pyimport("micropip");
            
            showStatus('正在本地安装 pydicom (3.0.1)...');
            // 关键修改 2：使用您本地的 whl 文件名和路径
            await micropip.install('./pydicom-3.0.1-py3-none-any.whl'); 
            
            showStatus('工具环境 v0.29.0 加载完成！');
            setTimeout(() => {
                hideStatus(); 
            }, 2000);

            // 成功加载后启用按钮
            hideSameBtn.disabled = false;
            showAllBtn.disabled = false;
            clearBtn.disabled = false;
            
        } catch (error) {
            console.error("加载 Pyodide 或安装 pydicom 失败:", error);
            // 提示用户检查是否通过本地服务器运行
            showStatus(`加载失败: ${error.message}。请确保通过 'http://' 地址运行，而不是直接双击。`, true);
        }
    }
    
    // --- Python 解析代码 (使用 pydicom) ---
    const parsePythonCode = `
import pydicom
import io

def parse_dicom_files():
    # 结构: {tag_str: {filename: {'value': val, 'name': name, 'vr': vr_val, 'vm': vm_val}}}
    parsed_data = {} 
    errors = []
    
    # 导入 pydicom 的字典，用于获取 VR/VM 信息
    from pydicom.datadict import dictionary_VR, dictionary_VM
    
    for filename, file_content_memoryview in loadedFiles.to_py().items():
        try:
            # 将 JavaScript 的 ArrayBuffer 转换为 Python bytes
            file_bytes = bytes(file_content_memoryview)
            file_stream = io.BytesIO(file_bytes)
            # 使用 force=True 尝试读取没有标准 DICOM 头的文件
            ds = pydicom.dcmread(file_stream, stop_before_pixels=True, force=True)
            
            for elem in ds.iterall():
                tag_str = str(elem.tag)
                
                if tag_str not in parsed_data:
                    parsed_data[tag_str] = {}
                
                # --- 新增：获取 VR 和 VM ---
                # 尝试从元素本身获取 VR/VM (对于私有或非标准 Tag)
                vr_val = elem.VR if hasattr(elem, 'VR') else (dictionary_VR.get(elem.tag, 'UN'))
                vm_val = elem.VM if hasattr(elem, 'VM') else (dictionary_VM.get(elem.tag, '1'))
                
                # 如果是 Sequence (SQ)，显示其特殊 VR/VM
                if vr_val == 'SQ':
                    value_str = f"Sequence with {len(elem.value)} item(s)"
                else:
                    # 正常获取值
                    value_str = str(elem.value)
                
                name_str = elem.name or 'Unknown'

                parsed_data[tag_str][filename] = {
                    'value': value_str, 
                    'name': name_str,
                    'vr': vr_val,      # <--- 添加 VR
                    'vm': str(vm_val)  # <--- 添加 VM (确保是字符串)
                }
        except Exception as e:
            errors.append(f"解析文件 {filename} 时出错: {str(e)}")
            
    return parsed_data, errors

parse_dicom_files()
`;
    
    // --- 文件处理函数 ---
    function handleFiles(files) {
        if (!pyodide) {
            showStatus('Pyodide 尚未加载完成，请稍候...', true);
            return;
        }

        const fileArray = Array.from(files);
        if (fileArray.length === 0) return;

        showStatus(`正在读取 ${fileArray.length} 个文件...`);

        let filesRead = 0;
        fileArray.forEach(file => {
            const reader = new FileReader();
            reader.onload = (event) => {
                // 使用 ArrayBuffer 提高效率
                loadedFiles.set(file.name, event.target.result);
                filesRead++;

                if (filesRead === fileArray.length) {
                    processAllFiles();
                }
            };
            reader.onerror = (error) => {
                console.error("文件读取失败:", error);
                showStatus(`文件 ${file.name} 读取失败!`, true);
            };
            reader.readAsArrayBuffer(file);
        });

        // 更新文件列表显示
        updateFileListDisplay();
    }
    
    function updateFileListDisplay() {
        fileListDisplay.innerHTML = '';
        if (loadedFiles.size === 0) {
            fileListDisplay.innerHTML = '未选择文件';
            return;
        }

        loadedFiles.forEach((_, name) => {
            const tag = document.createElement('span');
            tag.className = 'file-tag';
            tag.innerHTML = `${name} <span class="file-tag-delete" data-filename="${name}">&times;</span>`;
            fileListDisplay.appendChild(tag);
        });

        // 添加删除事件监听器
        fileListDisplay.querySelectorAll('.file-tag-delete').forEach(btn => {
            btn.addEventListener('click', (event) => {
                const filename = event.target.dataset.filename;
                loadedFiles.delete(filename);
                updateFileListDisplay();
                processAllFiles(); // 重新解析剩余文件
            });
        });
    }

    async function processAllFiles() {
        if (loadedFiles.size === 0) {
            currentParsedData = null;
            renderTable();
            return;
        }
        
        showStatus(`正在解析 ${loadedFiles.size} 个文件...`);

        try {
            // 将文件 Map 传递给 Python 全局环境
            pyodide.globals.set('loadedFiles', loadedFiles);

            // 执行 Python 代码
            // 注意：Python 返回的是 PyProxy 对象，需要 .toJs() 转换
            const pyResult = await pyodide.runPythonAsync(parsePythonCode);
            const [parsed_data_py, errors_py] = pyResult.toJs();
            
            // 将 Python 的 Map 转换为 JS 的 Map 或 Object
            const parsed_data_js = {};
            parsed_data_py.forEach((value, key) => {
                parsed_data_js[key] = value.toJs();
            });
            currentParsedData = parsed_data_js;


            if (errors_py && errors_py.length > 0) {
                 showStatus(`解析完成，但存在 ${errors_py.length} 个错误。`, true);
                 console.error("解析错误详情:", errors_py.toJs());
            } else {
                 showStatus('文件解析成功，正在渲染表格...');
            }

            renderTable();

        } catch (error) {
            console.error("Pyodide 运行时错误:", error);
            showStatus('Pyodide 运行时错误，请检查控制台。', true);
        } finally {
            // 稍后隐藏状态
            setTimeout(() => {
                hideStatus();
            }, 2000);
        }
    }
    
    // --- 表格渲染函数 ---
    function renderTable() {
        if (!currentParsedData || Object.keys(currentParsedData).length === 0) {
            tableContainer.innerHTML = '<p style="text-align: center; padding: 20px;">暂无数据，请先上传 DICOM 文件。</p>';
            return;
        }

        const filenames = Array.from(loadedFiles.keys());
        const allTags = Object.keys(currentParsedData);
        const fileCount = filenames.length;
        
        // 1. 计算所有 Tag 值的频率
        const tagValueFrequencies = {};
        const differentTags = new Set();
        
        allTags.forEach(tag => {
            const values = {};
            const fileInfo = currentParsedData[tag];

            filenames.forEach(filename => {
                // 确保 N/A 也是一个可计数的差异值
                const value = fileInfo[filename]?.value || 'N/A';
                values[value] = (values[value] || 0) + 1;
            });

            tagValueFrequencies[tag] = {};
            let numUniqueValues = Object.keys(values).length;

            if (numUniqueValues > 1) {
                differentTags.add(tag);
            }

            // 将计数转换为频率等级 (用于着色)
            for (const value in values) {
                const count = values[value];
                if (count === 1) {
                    tagValueFrequencies[tag][value] = 'low'; // 极少出现，最红
                } else if (count === 2) {
                    tagValueFrequencies[tag][value] = 'medium'; // 少数出现，中等红
                } else {
                    tagValueFrequencies[tag][value] = 'high'; // 大部分出现，不标红
                }
            }
        });
        
        // --- 表格主体渲染 ---
        let html = '<table><thead><tr><th>Tag</th><th>Tag Name</th><th>VR</th><th>VM</th>'; 
        filenames.forEach(name => {
            html += `<th class="file-name-row">${name}</th>`;
        });
        html += '</tr></thead><tbody>';

        const tagsToDisplay = hideSameTags ? Array.from(differentTags) : allTags;

        tagsToDisplay.forEach(tag => {
            const fileInfo = currentParsedData[tag];
            // 获取 Tag 的通用信息 (VR/VM/Name)
            const firstFilename = Object.keys(fileInfo)[0];
            const baseInfo = fileInfo[firstFilename];

            const tagName = baseInfo?.name || 'Unknown';
            const tagVR = baseInfo?.vr || 'UN';
            const tagVM = baseInfo?.vm || '1';
            
            // Tag 信息行
            html += `<tr><td><code>${tag}</code></td>`;
            html += `<td class="tag-name-cell">${tagName}</td>`;
            html += `<td style="text-align: center;">${tagVR}</td>`;
            html += `<td style="text-align: center;">${tagVM}</td>`;

            filenames.forEach(filename => {
                const valueObj = fileInfo[filename];
                const value = valueObj ? valueObj.value : 'N/A';
                
                const frequencyLevel = tagValueFrequencies[tag][value] || 'high'; 
                
                let cssClass = '';
                if (frequencyLevel === 'low') {
                    cssClass = ' class="freq-low"';
                } else if (frequencyLevel === 'medium') {
                    cssClass = ' class="freq-medium"';
                } 
                
                html += `<td${cssClass}>${value}</td>`;
            });
            html += '</tr>';
        });

        html += '</tbody></table>';
        tableContainer.innerHTML = html;
    }

    // --- 事件监听器 ---
    
    // 初始化时尝试加载 Pyodide
    window.onload = main; 

    dropZone.addEventListener('dragover', (event) => {
        event.preventDefault();
        dropZone.classList.add('dragover');
    });

    dropZone.addEventListener('dragleave', () => {
        dropZone.classList.remove('dragover');
    });

    dropZone.addEventListener('drop', (event) => {
        event.preventDefault();
        dropZone.classList.remove('dragover');
        const files = event.dataTransfer.files;
        handleFiles(files);
    });

    fileInput.addEventListener('change', (event) => {
        const files = event.target.files;
        handleFiles(files);
    });

    hideSameBtn.addEventListener('click', () => {
        hideSameTags = true;
        renderTable();
    });

    showAllBtn.addEventListener('click', () => {
        hideSameTags = false;
        renderTable();
    });

    clearBtn.addEventListener('click', () => {
        loadedFiles.clear();
        currentParsedData = null;
        tableContainer.innerHTML = '<p style="text-align: center; padding: 20px;">暂无数据，请先上传 DICOM 文件。</p>';
        updateFileListDisplay(); // 清空列表显示
        hideStatus();
        // 禁用按钮，只有在 Pyodide 重新加载文件后才启用
        // 注意：这里可以保持启用，因为 Pyodide 核心已加载
        // hideSameBtn.disabled = true;
        // showAllBtn.disabled = true;
        // clearBtn.disabled = true;
    });

</script>
</body>
</html>
